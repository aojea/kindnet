<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/kindnet/favicons/favicon.ico><link rel=apple-touch-icon href=/kindnet/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/kindnet/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/kindnet/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/kindnet/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/kindnet/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/kindnet/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/kindnet/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/kindnet/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/kindnet/favicons/android-192x192.png sizes=192x192><title>Fastpath | Kindnet</title>
<meta name=description content="Kindnet offers a fastpath feature to significantly boost network performance. This feature leverages the kernel’s flowtable architecture to offload network traffic processing, reducing latency and increasing throughput.
What is Fastpath? Fastpath is a mechanism that bypasses the normal Kubernetes networking path for specific network flows. By identifying and offloading these flows to the kernel’s flowtable, Kindnet reduces the overhead associated with processing each packet individually.
The kernel Netfilter’s flowtable infrastructure allows to define a fastpath through the flowtable datapath."><meta property="og:url" content="https://aojea.github.io/kindnet/docs/user/fastpath/"><meta property="og:site_name" content="Kindnet"><meta property="og:title" content="Fastpath"><meta property="og:description" content="Kindnet offers a fastpath feature to significantly boost network performance. This feature leverages the kernel’s flowtable architecture to offload network traffic processing, reducing latency and increasing throughput.
What is Fastpath? Fastpath is a mechanism that bypasses the normal Kubernetes networking path for specific network flows. By identifying and offloading these flows to the kernel’s flowtable, Kindnet reduces the overhead associated with processing each packet individually.
The kernel Netfilter’s flowtable infrastructure allows to define a fastpath through the flowtable datapath."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2024-12-27T12:39:58+00:00"><meta property="article:modified_time" content="2024-12-27T12:39:58+00:00"><meta itemprop=name content="Fastpath"><meta itemprop=description content="Kindnet offers a fastpath feature to significantly boost network performance. This feature leverages the kernel&rsquo;s flowtable architecture to offload network traffic processing, reducing latency and increasing throughput.
What is Fastpath? Fastpath is a mechanism that bypasses the normal Kubernetes networking path for specific network flows. By identifying and offloading these flows to the kernel&rsquo;s flowtable, Kindnet reduces the overhead associated with processing each packet individually.
The kernel Netfilter’s flowtable infrastructure allows to define a fastpath through the flowtable datapath."><meta itemprop=datePublished content="2024-12-27T12:39:58+00:00"><meta itemprop=dateModified content="2024-12-27T12:39:58+00:00"><meta itemprop=wordCount content="582"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fastpath"><meta name=twitter:description content="Kindnet offers a fastpath feature to significantly boost network performance. This feature leverages the kernel&rsquo;s flowtable architecture to offload network traffic processing, reducing latency and increasing throughput.
What is Fastpath? Fastpath is a mechanism that bypasses the normal Kubernetes networking path for specific network flows. By identifying and offloading these flows to the kernel&rsquo;s flowtable, Kindnet reduces the overhead associated with processing each packet individually.
The kernel Netfilter’s flowtable infrastructure allows to define a fastpath through the flowtable datapath."><link rel=preload href=/kindnet/scss/main.min.5e43f8574351718e9b44966c9f3a571202ed048c082f457fb574c10b1a1bc56c.css as=style integrity="sha256-XkP4V0NRcY6bRJZsnzpXEgLtBIwIL0V/tXTBCxobxWw=" crossorigin=anonymous><link href=/kindnet/scss/main.min.5e43f8574351718e9b44966c9f3a571202ed048c082f457fb574c10b1a1bc56c.css rel=stylesheet integrity="sha256-XkP4V0NRcY6bRJZsnzpXEgLtBIwIL0V/tXTBCxobxWw=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/kindnet/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Kindnet</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/kindnet/docs><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/kindnet/docs/user><span>User Guides</span></a></li><li class=nav-item><a class=nav-link href=/kindnet/docs/design><span>Design</span></a></li><li class=nav-item><a class=nav-link href=/kindnet/docs/contributing><span>Contributing</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-kindnetdocs-li><a href=/kindnet/docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-kindnetdocs><span>kindnet</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kindnetdocsquick-start-li><a href=/kindnet/docs/quick-start/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-kindnetdocsquick-start><span>Quick Start</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-kindnetdocsuser-li><a href=/kindnet/docs/user/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-kindnetdocsuser><span>User Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kindnetdocsuserconfiguration-li><a href=/kindnet/docs/user/configuration/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-kindnetdocsuserconfiguration><span>Configuration Options</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kindnetdocsusernetwork-policies-li><a href=/kindnet/docs/user/network-policies/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-kindnetdocsusernetwork-policies><span>Network Policies</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-kindnetdocsuserfastpath-li><a href=/kindnet/docs/user/fastpath/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-kindnetdocsuserfastpath><span class=td-sidebar-nav-active-item>Fastpath</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kindnetdocsuserdnscache-li><a href=/kindnet/docs/user/dnscache/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-kindnetdocsuserdnscache><span>DNS cache</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kindnetdocsusernat64-li><a href=/kindnet/docs/user/nat64/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-kindnetdocsusernat64><span>NAT64</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-kindnetdocsdesign-li><a href=/kindnet/docs/design/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-kindnetdocsdesign><span>Design</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kindnetdocsdesigncni-li><a href=/kindnet/docs/design/cni/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-kindnetdocsdesigncni><span>CNI</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kindnetdocsdesignkindnet-li><a href=/kindnet/docs/design/kindnet/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-kindnetdocsdesignkindnet><span>Kindnet</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-kindnetdocscontributing-li><a href=/kindnet/docs/contributing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-kindnetdocscontributing><span>Contributing</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/aojea/kindnet/tree/main/site/content/docs/user/fastpath/index.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/aojea/kindnet/edit/main/site/content/docs/user/fastpath/index.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/aojea/kindnet/new/main/site/content/docs/user/fastpath?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/aojea/kindnet/issues/new?title=Fastpath" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><ul><li><a href=#what-is-fastpath>What is Fastpath?</a></li><li><a href=#how-it-works>How it Works</a></li><li><a href=#performance-improvements>Performance Improvements</a></li><li><a href=#troubleshooting>Troubleshooting</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/kindnet/docs/>kindnet</a></li><li class=breadcrumb-item><a href=/kindnet/docs/user/>User Guides</a></li><li class="breadcrumb-item active" aria-current=page>Fastpath</li></ol></nav><div class=td-content><h1>Fastpath</h1><header class=article-meta></header><p>Kindnet offers a fastpath feature to significantly boost network performance. This feature leverages the kernel&rsquo;s flowtable architecture to offload network traffic processing, reducing latency and increasing throughput.</p><h3 id=what-is-fastpath>What is Fastpath?</h3><p>Fastpath is a mechanism that bypasses the normal Kubernetes networking path for specific network flows. By identifying and offloading these flows to the kernel&rsquo;s flowtable, Kindnet reduces the overhead associated with processing each packet individually.</p><p>The kernel <a href=https://docs.kernel.org/networking/nf_flowtable.html>Netfilter’s flowtable infrastructure</a> allows to define a fastpath through the flowtable datapath. This infrastructure also provides hardware offload support.</p><pre tabindex=0><code>                                       userspace process
                                        ^              |
                                        |              |
                                   _____|____     ____\/___
                                  /          \   /         \
                                  |   input   |  |  output  |
                                  \__________/   \_________/
                                       ^               |
                                       |               |
    _________      __________      ---------     _____\/_____
   /         \    /          \     |Routing |   /            \
--&gt;  ingress  ---&gt; prerouting ---&gt; |decision|   | postrouting |--&gt; neigh_xmit
   \_________/    \__________/     ----------   \____________/          ^
     |      ^                          |               ^                |
 flowtable  |                     ____\/___            |                |
     |      |                    /         \           |                |
  __\/___   |                    | forward |------------                |
  |-----|   |                    \_________/                            |
  |-----|   |                 &#39;flow offload&#39; rule                       |
  |-----|   |                   adds entry to                           |
  |_____|   |                     flowtable                             |
     |      |                                                           |
    / \     |                                                           |
   /hit\_no_|                                                           |
   \ ? /                                                                |
    \ /                                                                 |
     |__yes_________________fastpath bypass ____________________________|
             Fig.1 Netfilter hooks and flowtable interactions
</code></pre><h3 id=how-it-works>How it Works</h3><p>Kindnet monitors network traffic patterns. When it detects a connection with more than a certain number of packets (the threshold), it automatically offloads that flow to the fastpath. The default threshold is 20 packets, designed to optimize performance by avoiding the overhead of offloading short-lived flows.</p><p><img src=kernel_fastpath.png alt="Kernel fastpath"></p><p>Users can define the threshold via the flag <code>--fastpath-threshold</code>, or completely disable the feature by setting the threshold to 0.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - args:
</span></span><span style=display:flex><span>        - /bin/kindnetd
</span></span><span style=display:flex><span>        - --hostname-override=$(NODE_NAME)
</span></span><span style=display:flex><span>        - --fastpath-threshold=6
</span></span><span style=display:flex><span>        - --v=2
</span></span></code></pre></div><h3 id=performance-improvements>Performance Improvements</h3><p>Bypassing the Kernel stack has some important performance improvements, not only on the throughput available but also on the resource consumption of the host.</p><p>As an example, running a simple <code>iperf</code> test on a <code>kind</code> cluster</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl run client --image=registry.k8s.io/e2e-test-images/agnhost:2.53
</span></span><span style=display:flex><span>$ kubectl run server --image=registry.k8s.io/e2e-test-images/agnhost:2.53
</span></span></code></pre></div><p>Without <code>fastpath</code>:</p><pre tabindex=0><code>$ kubectl exec -it client -- iperf -c 10.244.1.32
------------------------------------------------------------
Client connecting to 10.244.1.32, TCP port 5001
TCP window size: 16.0 KByte (default)
------------------------------------------------------------
[  1] local 10.244.2.93 port 55398 connected with 10.244.1.32 port 5001
[ ID] Interval       Transfer     Bandwidth
[  1] 0.00-10.01 sec  37.5 GBytes  32.1 Gbits/sec
</code></pre><p>Enabling <code>fastpath</code> shows a considerable improvement, from 32.1 Gbps to 38.1 Gbps:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl exec -it client -- iperf -c 10.244.1.32            
</span></span><span style=display:flex><span>------------------------------------------------------------
</span></span><span style=display:flex><span>Client connecting to 10.244.1.32, TCP port 5001
</span></span><span style=display:flex><span>TCP window size: 16.0 KByte (default)
</span></span><span style=display:flex><span>------------------------------------------------------------
</span></span><span style=display:flex><span>[  1] local 10.244.2.93 port 42212 connected with 10.244.1.32 port 5001
</span></span><span style=display:flex><span>[ ID] Interval       Transfer     Bandwidth
</span></span><span style=display:flex><span>[  1] 0.00-10.00 sec  44.4 GBytes  38.1 Gbits/sec
</span></span></code></pre></div><h3 id=troubleshooting>Troubleshooting</h3><p>Kindnet uses nftables to enable the faspath, if the feature is not working well or misbehaving users can find the configuration in the corresponding nftables table <code>kindnet-fastpath</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ nft list table inet kindnet-fastpath
</span></span><span style=display:flex><span>table inet kindnet-fastpath {
</span></span><span style=display:flex><span>        comment <span style=color:#a31515>&#34;rules for kindnet fastpath&#34;</span>
</span></span><span style=display:flex><span>        flowtable kindnet-flowtables {
</span></span><span style=display:flex><span>                hook ingress priority filter
</span></span><span style=display:flex><span>                devices = { eth0, knet379d0a5f, knetabb40db0 }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        chain kindnet-fastpath-chain {
</span></span><span style=display:flex><span>                type filter hook forward priority -110; policy accept;
</span></span><span style=display:flex><span>                ct packets &gt; 20 flow add @kindnet-flowtables counter packets 1 bytes 7292
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>flowtable</code> must contain the list of interfaces on the Node, only the interfaces present on that <code>devices</code> list of that table will be able to use the fastpath.</p><p>The chain <code>kindnet-fastpath-chain</code> has a counter with the number of packets and bytes that are offloaded, if this counter does not increase means no connections are being accelerated.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="SIG Network mailing list" aria-label="SIG Network mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/kubernetes-sig-network aria-label="SIG Network mailing list"><i class="fa fa-envelope"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/aojea/kindnet aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://kubernetes.slack.com/messages/sig-network aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2019&ndash;2024
<span class=td-footer__authors>Antonio Ojea | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/kindnet/js/main.min.2f4221c134a3d4fc924ec74d95427ad328756dd363d839bd100b72da5873afdf.js integrity="sha256-L0IhwTSj1PySTsdNlUJ60yh1bdNj2Dm9EAty2lhzr98=" crossorigin=anonymous></script><script defer src=/kindnet/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/kindnet/js/tabpane-persist.js></script></body></html>